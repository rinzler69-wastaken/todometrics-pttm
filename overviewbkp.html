{{ define "overview.html" }}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overview | todometrics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
  <style>
    body {
      padding-top: 5rem; padding-bottom: 2rem;
      background-image: url('/static/images/bg.jpg');
      background-size: cover; background-repeat: no-repeat; background-position: center; background-attachment: fixed;
      font-family: 'IBM Plex Sans', sans-serif;
    }
    body::before {
      content: ""; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.4); z-index: -1;
    }
    .stat-card {
      border: 2px solid; border-left: 6px solid; border-radius: 1rem;
      padding: 1.25rem; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      display: flex; flex-direction: column; justify-content: space-between; aspect-ratio: 1 / 1;
      position: relative; overflow: hidden;
      /* Smooth transitions for all properties */
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      /* Initial state for page load animation */
      opacity: 0;
      transform: translateY(30px);
    }
    
    .stat-card.fade-in {
      animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes blipIn {
        0% { opacity: 0; transform: scale(0.5, 0); }
        50% { opacity: 1; transform: scale(1, 0.01); }
        100% { opacity: 1; transform: scale(1, 1); }
    }


    .graph-pane {
      border: 2px solid rebeccapurple; border-left: 6px solid rebeccapurple;
      border-radius: 1rem; padding: 1.5rem;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      background-color: rgba(102, 51, 153, 0.05); height: 300px;
      /* Initial state for page load animation */
      opacity: 0;
      /* transform: translateY(40px); */
    }
    
    .graph-pane.fade-in {
      /* animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; */
      animation: blipIn 0.2s ease-out forwards;
    }
    /* Color Palette */
    .border-indigo, .border-purple { border-color: rebeccapurple; }
    .border-yellow { border-color: #ffc107; }
    .border-red { border-color: #dc3545; }
    .border-blue { border-color: #0d6efd; }
    .border-green { border-color: #198754; }
    .text-indigo, .text-purple { color: rebeccapurple; }
    .text-yellow { color: #ffc107; }
    .text-red { color: #dc3545; }
    .text-blue { color: #0d6efd; }
    .text-green { color: #198754; }
    .bg-gradient-indigo, .bg-gradient-purple { background: linear-gradient(135deg, rgba(102, 51, 153, 0.2), rgba(102, 51, 153, 0.05)); }
    .bg-gradient-yellow { background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.05)); }
    .bg-gradient-red { background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.05)); }
    .bg-gradient-blue { background: linear-gradient(135deg, rgba(13, 110, 253, 0.15), rgba(13, 110, 253, 0.03)); }
    .bg-gradient-green { background: linear-gradient(135deg, rgba(25, 135, 84, 0.2), rgba(25, 135, 84, 0.05)); }
    
    .stat-number { 
      font-size: 3.5rem; font-weight: bold; 
      transition: color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-label {
      transition: color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .icon-placeholder { 
      opacity: 0.5; font-size: 3.5rem; position: absolute; right: 1rem; bottom: 0.5rem;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .gtk-navbar { background: linear-gradient(to bottom, #ffffff, #f1f1f1); border-bottom: 1px solid #ddd; }
    .navbar-brand { color: #4b0082; }
    .hover-overview:hover { background-color: rebeccapurple; color: #fff !important; }
    .hover-tasks:hover { background-color: #0d6efd; color: #fff !important; }
    .hover-completed:hover { background-color: #198754; color: #fff !important; }
    .hover-about:hover { background-color: #ffc107; color: #fff !important; }
    .btn .material-symbols-outlined { margin-right: 0.3rem; font-size: 1.1em; vertical-align: text-bottom; }
    
    /* Updated view-option styling to match Bootstrap buttons */
    .view-option { 
      cursor: pointer; 
      border: 1px solid #dee2e6; 
      padding: 0.5rem 1rem; 
      border-radius: 50rem; /* Rounded pill shape like Apply View button */
      transition: all 0.15s ease-in-out; 
      background-color: #fff;
      color: #6c757d;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
      min-width: 120px; /* Fixed width for consistency */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Active and hover states for different button types */
    .view-option[data-view="ongoing"]:hover,
    .view-option[data-view="ongoing"].active {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: #fff;
    }
    
    .view-option[data-view="completed"]:hover,
    .view-option[data-view="completed"].active {
      background-color: #198754;
      border-color: #198754;
      color: #fff;
    }
    
    .view-option[data-sort="urgency"]:hover,
    .view-option[data-sort="urgency"].active {
      background-color: #dc3545;
      border-color: #dc3545;
      color: #fff;
    }
    
    .view-option[data-sort="priority"]:hover,
    .view-option[data-sort="priority"].active {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #000;
    }
    
    .legend-swatch { display: inline-block; width: 12px; height: 12px; margin-right: 0.5rem; border-radius: 3px; }

    .modal-content {
      border-radius: 1.2rem !important; /* Use !important to ensure override */
      border: 1px solid rgba(128, 128, 128, 0.2);
      /* backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px); */
      background-color: #f1f1f1;
    }

    .modal-header, .modal-footer {
      /* Lighter separators for the frosted look */
      border-color: rgba(0, 0, 0, 0.1); 
    }

    /* 1. Override Bootstrap's default state. 
          Instead of being off-screen, the modal will start as a collapsed line. */
    .modal.fade .modal-dialog {
      transform: scale(1, 0);
      transition: transform 0.18s ease-out; /* Use transition instead of animation */
    }

    /* 2. Define the 'shown' state. 
          When Bootstrap adds the .show class, the modal will scale to its full size. */
    .modal.show .modal-dialog {
      transform: scale(1, 1);
    }

    .bg-purple {
      background-color:rebeccapurple
    }

    .drop-shadow {
      filter: drop-shadow(0 0.5rem 1rem rgba(0, 0, 0, 0.15));
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg shadow fixed-top bg-white gtk-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
        <img src="/static/images/navbrand.svg" alt="todometrics" height="30">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse justify-content-end pt-3 pt-lg-0" id="mainNavbar">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link px-3 rounded-pill me-lg-2 {{ if eq .active "overview" }}bg bg-purple text-white{{ else }}text-dark hover-overview{{ end }}" href="/">Overview</a></li>
        <li class="nav-item"><a class="nav-link px-3 rounded-pill me-lg-2 {{ if eq .active "tasks" }}bg-primary text-white{{ else }}text-dark hover-tasks{{ end }}" href="/tasks">Tasks</a></li>
        <li class="nav-item"><a class="nav-link px-3 rounded-pill me-lg-2 {{ if eq .active "completed" }}bg-success text-white{{ else }}text-dark hover-completed{{ end }}" href="/completed">Completed Tasks</a></li>
        <li class="nav-item"><a class="nav-link px-3 rounded-pill me-lg-2 {{ if eq .active "about" }}bg-warning text-white{{ else }}text-dark hover-about{{ end }}" href="/about">About</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <h1 class="text-center mb-4">Tasks Overview</h1>
  <p class="text-muted text-center mb-4">A dashboard of your key task statistics and performance metrics.</p>

  <div class="d-flex flex-wrap justify-content-center align-items-center gap-3 mb-4">
    <button class="btn btn-primary rounded-pill shadow-lg" data-bs-toggle="modal" data-bs-target="#viewOptionsModal">
        <span class="material-symbols-outlined">tune</span>
        Configure View
    </button>
    <span id="viewStatusTag" class="d-flex align-items-center gap-2 border bg-white rounded-pill px-3 py-1 shadow-sm">
        <!-- Content will be set by JavaScript -->
    </span>
  </div>

<div id="statBoxGrid" class="row row-cols-2 row-cols-lg-4 g-2 mb-5">
  <!-- Stat boxes will be dynamically generated by JavaScript -->
  <div class="col stat-card-col"><div id="stat-box-0" class="position-relative stat-card shadow-sm"><div class="fw-bold stat-label"></div><div class="stat-number"></div><div class="icon-placeholder"></div></div></div>
  <div class="col stat-card-col"><div id="stat-box-1" class="position-relative stat-card shadow-sm"><div class="fw-bold stat-label"></div><div class="stat-number"></div><div class="icon-placeholder"></div></div></div>
  <div class="col stat-card-col"><div id="stat-box-2" class="position-relative stat-card shadow-sm"><div class="fw-bold stat-label"></div><div class="stat-number"></div><div class="icon-placeholder"></div></div></div>
  <div class="col stat-card-col"><div id="stat-box-3" class="position-relative stat-card shadow-sm"><div class="fw-bold stat-label"></div><div class="stat-number"></div><div class="icon-placeholder"></div></div></div>
</div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Performance Graph</h5>
    <div class="d-flex gap-2">
      <button id="monthlyBtn" class="btn btn-sm rounded-pill btn-success"><span class="material-symbols-outlined">radio_button_checked</span>Monthly</button>
      <button id="yearlyBtn" class="btn btn-sm rounded-pill btn-primary"><span class="material-symbols-outlined">radio_button_unchecked</span>Yearly</button>
    </div>
  </div>

  <div class="graph-pane shadow-sm position-relative">
    <canvas id="performanceChart"></canvas>
    <div id="chartPlaceholder" class="d-none text-center text-muted h-100 d-flex align-items-center justify-content-center">
        <em>No performance data available for this period.<br>Complete some tasks to get started!</em>
    </div>
  </div>

  <div class="mt-3">
    <div class="d-flex justify-content-center align-items-center gap-3 mb-2">
        <span class="d-flex align-items-center small text-muted"><span class="legend-swatch" style="background-color: rebeccapurple;"></span>Exceptional (>1.5)</span>
        <span class="d-flex align-items-center small text-muted"><span class="legend-swatch" style="background-color: #198754;"></span>Good (0.5-1.5)</span>
        <span class="d-flex align-items-center small text-muted"><span class="legend-swatch" style="background-color: #dc3545;"></span>Poor (<0.5)</span>
    </div>
    <p id="chartDescription" class="text-center text-muted small">
        This graph shows your average performance score for each of the last 12 months.
    </p>
  </div>
</div>

<!-- View Options Modal -->
<div class="modal fade" id="viewOptionsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered drop-shadow">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Configure Overview</h5><button type="button" class="btn-close rounded-circle bg-white border shadow-sm" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <h6>Stat Type</h6>
          <div class="d-flex gap-2 mb-3">
              <div class="view-option w-50 shadow-sm active" data-view="ongoing"><strong>Ongoing</strong></div>
              <div class="view-option w-50 shadow-sm" data-view="completed"><strong>Completed</strong></div>
          </div>
          <div id="ongoingSortOptions">
              <h6>Show Ongoing Stats By</h6>
              <div class="d-flex gap-2">
                  <div class="view-option w-50 shadow-sm active" data-sort="urgency"><strong>Urgency</strong></div>
                  <div class="view-option w-50 shadow-sm" data-sort="priority"><strong>Priority</strong></div>
              </div>
          </div>
      </div>
      <div class="modal-footer"><button id="applyViewBtn" type="button" class="btn btn-primary rounded-pill" data-bs-dismiss="modal">Apply View</button></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- NEW DYNAMIC STATS LOGIC ---
        const statBoxes = [
            document.getElementById('stat-box-0'),
            document.getElementById('stat-box-1'),
            document.getElementById('stat-box-2'),
            document.getElementById('stat-box-3'),
        ];
        const viewStatusTag = document.getElementById('viewStatusTag');
        let currentView = 'ongoing';
        let currentSort = 'urgency';

        function scrambleAnimate(element, finalValue, isNumeric) {
            const chars = isNumeric ? '0123456789' : 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let interval = null;
            let counter = 0;
            const duration = 20; // Slightly longer for better effect
            
            interval = setInterval(() => {
                let scrambledText = '';
                for (let i = 0; i < String(finalValue).length; i++) {
                    if (String(finalValue)[i] === ' ') { 
                        scrambledText += ' '; 
                    } else { 
                        scrambledText += chars[Math.floor(Math.random() * chars.length)]; 
                    }
                }
                element.textContent = scrambledText;
                counter++;
                if(counter > duration) {
                    clearInterval(interval);
                    element.textContent = finalValue;
                }
            }, 40); // Slightly slower for smoother appearance
        }

        async function updateStatboxes() {
            const response = await fetch(`/api/overview/stats?view=${currentView}&sort=${currentSort}`);
            const data = await response.json();

            statBoxes.forEach((box, i) => {
                const stat = data[i];
                const labelEl = box.querySelector('.stat-label');
                const numberEl = box.querySelector('.stat-number');
                const iconEl = box.querySelector('.icon-placeholder');

                // Update classes for seamless color transition
                // Remove all existing color classes
                box.classList.remove(
                    'border-indigo', 'border-purple', 'border-yellow', 'border-red', 'border-blue', 'border-green',
                    'text-indigo', 'text-purple', 'text-yellow', 'text-red', 'text-blue', 'text-green',
                    'bg-gradient-indigo', 'bg-gradient-purple', 'bg-gradient-yellow', 'bg-gradient-red', 'bg-gradient-blue', 'bg-gradient-green'
                );
                
                // Add new color classes
                box.classList.add(`border-${stat.color}`, `text-${stat.color}`, `bg-gradient-${stat.color}`);
                
                // Start scrambling animations simultaneously with color transitions
                scrambleAnimate(labelEl, stat.label, false);
                scrambleAnimate(numberEl, stat.value, true);
                
                // Update icon with smooth transition
                iconEl.textContent = stat.icon;
            });

            // Update status tag
            let statusText = '';
            if (currentView === 'completed') {
                statusText = '<strong>Completed Stats</strong>';
            } else {
                statusText = `<strong>Ongoing by ${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}</strong>`;
            }
            viewStatusTag.innerHTML = `Viewing: ${statusText}`;
        }

        // Modal Logic
        const applyBtn = document.getElementById('applyViewBtn');
        const viewOptions = document.querySelectorAll('.view-option[data-view]');
        const sortOptions = document.querySelectorAll('.view-option[data-sort]');
        const ongoingSortDiv = document.getElementById('ongoingSortOptions');

        viewOptions.forEach(option => {
            option.addEventListener('click', () => {
                viewOptions.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                if (option.dataset.view === 'completed') {
                    ongoingSortDiv.classList.add('d-none');
                } else {
                    ongoingSortDiv.classList.remove('d-none');
                }
            });
        });
        
        sortOptions.forEach(option => {
            option.addEventListener('click', () => {
                sortOptions.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
            });
        });

        applyBtn.addEventListener('click', () => {
            currentView = document.querySelector('.view-option[data-view].active').dataset.view;
            if (currentView === 'ongoing') {
                currentSort = document.querySelector('.view-option[data-sort].active').dataset.sort;
            } else {
                currentSort = '';
            }
            updateStatboxes();
        });

        // Initial load with staggered fade-in animation
        statBoxes.forEach((box, index) => {
            setTimeout(() => {
                box.classList.add('fade-in');
            }, index * 150); // 150ms delay between each box
        });
        
        // Animate graph pane after statboxes
        setTimeout(() => {
            document.querySelector('.graph-pane').classList.add('fade-in');
        }, 300); // Start after all statboxes (4 * 150ms = 600ms)
        
        updateStatboxes();

        // --- Chart Logic ---
        const ctx = document.getElementById('performanceChart');
        let performanceChart; 
        const monthlyBtn = document.getElementById('monthlyBtn');
        const yearlyBtn = document.getElementById('yearlyBtn');
        const chartDescription = document.getElementById('chartDescription');

        async function updateChart(view) {
            const response = await fetch(`/api/overview/chart-data?chart=${view}`);
            const data = await response.json();
            const allScoresAreZero = data.scores.every(score => score === 0);
            if (allScoresAreZero) {
                ctx.classList.add('d-none');
                document.getElementById('chartPlaceholder').classList.remove('d-none');
                if (performanceChart) { performanceChart.destroy(); performanceChart = null; }
                return;
            } else {
                ctx.classList.remove('d-none');
                document.getElementById('chartPlaceholder').classList.add('d-none');
            }
            const backgroundColors = data.scores.map(score => {
                if (score > 1.5) return 'rgba(102, 51, 153, 0.7)';
                if (score < 0.5) return 'rgba(220, 53, 69, 0.7)';
                return 'rgba(25, 135, 84, 0.7)';
            });
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));
            if (performanceChart) {
                performanceChart.data.labels = data.labels;
                performanceChart.data.datasets[0].data = data.scores;
                performanceChart.data.datasets[0].backgroundColor = backgroundColors;
                performanceChart.data.datasets[0].borderColor = borderColors;
                performanceChart.update();
            } else {
                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: data.labels, datasets: [{ label: 'Avg. Performance Score', data: data.scores, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: false, ticks: { color: '#6c757d' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#6c757d' }, grid: { display: false } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        
        monthlyBtn.addEventListener('click', () => {
            updateChart('monthly');
            chartDescription.textContent = 'This graph shows your average performance score for each of the last 12 months.';
            monthlyBtn.querySelector('.material-symbols-outlined').textContent = 'radio_button_checked';
            yearlyBtn.querySelector('.material-symbols-outlined').textContent = 'radio_button_unchecked';
        });
        
        yearlyBtn.addEventListener('click', () => {
            updateChart('yearly');
            chartDescription.textContent = 'This graph shows your average performance score for each of the last 5 years.';
            yearlyBtn.querySelector('.material-symbols-outlined').textContent = 'radio_button_checked';
            monthlyBtn.querySelector('.material-symbols-outlined').textContent = 'radio_button_unchecked';
        });
        
        updateChart('monthly');
    });
</script>
</body>
</html>
{{ end }}